<!DOCTYPE html>

<html>
<head>
  <title>butler.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
 
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
           <div id="jump_page_wrapper">
            <div id="jump_page">
            
                <h4>.</h4>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/butler.html">
                    ./butler.js
                  </a>

                
            
                <h4>rest</h4>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/butlerPing.html">
                    rest/butlerPing.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/createDir.html">
                    rest/createDir.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/getDiskSpace.html">
                    rest/getDiskSpace.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/index.html">
                    rest/index.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/mqttPublishMessage.html">
                    rest/mqttPublishMessage.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/senseQRSPing.html">
                    rest/senseQRSPing.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/senseStartTask.html">
                    rest/senseStartTask.js
                  </a>

                

                  <a class="source" href="/Users/goran/code/qlik-sense-butler/src/docs/rest/slackPostMessage.html">
                    rest/slackPostMessage.js
                  </a>

                
            
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                <h1></h1>
                <h2>. / butler.js</h2>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Add dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
<span class="hljs-keyword">var</span> slack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-slack'</span>);
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>);
<span class="hljs-keyword">var</span> disk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'diskusage'</span>);
<span class="hljs-keyword">var</span> mqtt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mqtt'</span>);
<span class="hljs-keyword">var</span> dgram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dgram'</span>);
<span class="hljs-keyword">var</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);
<span class="hljs-keyword">var</span> QRS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'qrs'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'config'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Load code from sub modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> rest = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./rest'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Slack config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> slackWebhookURL = config.get(<span class="hljs-string">'Butler.slackConfig.webhookURL'</span>);
<span class="hljs-keyword">var</span> slackLoginNotificationChannel = config.get(<span class="hljs-string">'Butler.slackConfig.loginNotificationChannel'</span>);
<span class="hljs-keyword">var</span> slackTaskFailureChannel = config.get(<span class="hljs-string">'Butler.slackConfig.taskFailureChannel'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create Slack object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> slack = <span class="hljs-keyword">new</span> slack(slackWebhookURL);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set up connection parameters for Sense QRS API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> qrsConfig = {
  <span class="hljs-string">"host"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.serverIP'</span>),
  <span class="hljs-string">"useSSL"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.useSSL'</span>),
  <span class="hljs-string">"xrfkey"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.xrfkey'</span>),
  <span class="hljs-string">"authentication"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.authentication'</span>),
  <span class="hljs-string">"headerKey"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.headerKey'</span>),
  <span class="hljs-string">"headerValue"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.headerValue'</span>),
  <span class="hljs-string">"virtualProxy"</span>: config.get(<span class="hljs-string">'Butler.qrsConfig.virtualProxy'</span>)
};
<span class="hljs-keyword">var</span> qrs = <span class="hljs-keyword">new</span> QRS( qrsConfig );</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create MQTT client object and connect to MQTT broker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> mqttClient  = mqtt.connect(<span class="hljs-string">'mqtt://'</span> + config.get(<span class="hljs-string">'Butler.mqttConfig.brokerIP'</span>));
<span class="hljs-comment">/*
Following might be needed for conecting to older Mosquitto versions
var mqttClient  = mqtt.connect('mqtt://&lt;IP of MQTT server&gt;', {
  protocolId: 'MQIsdp',
  protocolVersion: 3
});
*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create restServer object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> restServer = restify.createServer({
  name: <span class="hljs-string">'Butler for Qlik Sense'</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Enable parsing of http parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>restServer.use(restify.queryParser());</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>UDP server connection parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> UDP_HOST = config.get(<span class="hljs-string">'Butler.udpServerConfig.serverIP'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Prepare to listen on port 9997 for incoming UDP connections regarding session starting/stoping, or connection opening/closing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> udpServerSessionConnection = dgram.createSocket({type:<span class="hljs-string">"udp4"</span>, reuseAddr:<span class="hljs-literal">true</span>});
<span class="hljs-keyword">const</span> UDP_PORT_SESSION_CONNECTION = config.get(<span class="hljs-string">'Butler.udpServerConfig.portSessionConnectionEvents'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Prepare to listen on port 9998 for incoming UDP connections regarding failed tasks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> udpServerTaskFailure = dgram.createSocket({type:<span class="hljs-string">"udp4"</span>, reuseAddr:<span class="hljs-literal">true</span>});
<span class="hljs-keyword">const</span> UDP_PORT_TASK_FAILURE = config.get(<span class="hljs-string">'Butler.udpServerConfig.portTaskFailure'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Handler for MQTT connect messages. Called when connection to MQTT broker has been established</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mqttClient.on(<span class="hljs-string">'connect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'Connected to MQTT broker'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Let the world know that Butler is connected to MQTT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(<span class="hljs-string">'qliksense/butler/mqtt/status'</span>, <span class="hljs-string">'Connected to MQTT broker'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Have Butler listen to all messages in the qliksense/ subtree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.subscribe(<span class="hljs-string">'qliksense/#'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Handler for MQTT messages matching the previously set up subscription</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mqttClient.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topic, message</span>) </span>{

  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'MQTT message received'</span>);
  <span class="hljs-built_in">console</span>.info(topic.toString());
  <span class="hljs-built_in">console</span>.info(message.toString());</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>MQTT message dispatch</strong>
Start Sense task</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (topic == <span class="hljs-string">'qliksense/start_task'</span>) {
    startSenseTask(message.toString());
  };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Handler for MQTT errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mqttClient.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topic, message</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Error occured</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'MQTT error'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="set-up-udp-server-for-acting-on-sense-session-and-connection-events">Set up UDP server for acting on Sense session and connection events</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Handler for UDP server startup event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerSessionConnection.on(<span class="hljs-string">'listening'</span>, () =&gt; {
  <span class="hljs-keyword">var</span> address = udpServerSessionConnection.address();
  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'UDP server listening on %s:%s'</span>, address.address, address.port);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Publish MQTT message that UDP server has started</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(<span class="hljs-string">'qliksense/butler/session_server'</span>, <span class="hljs-string">'start'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Handler for UDP error event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerSessionConnection.on(<span class="hljs-string">'error'</span>, () =&gt; {
  <span class="hljs-keyword">var</span> address = udpServerSessionConnection.address();
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'UDP server error on %s:%s'</span>, address.address, address.port);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Publish MQTT message that UDP server has reported an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(<span class="hljs-string">'qliksense/butler/session_server'</span>, <span class="hljs-string">'error'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Main handler for UDP messages relating to session and connection events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerSessionConnection.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message, remote</span>) </span>{
  <span class="hljs-keyword">var</span> msg = message.toString().split(<span class="hljs-string">';'</span>);
  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'%s: %s for user %s/%s'</span>, msg[<span class="hljs-number">0</span>], msg[<span class="hljs-number">1</span>], msg[<span class="hljs-number">2</span>], msg[<span class="hljs-number">3</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Send Slack message when session starts/stops, or a connection open/close</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slack.send({
    text: msg[<span class="hljs-number">1</span>] + <span class="hljs-string">' for user '</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'/'</span> + msg[<span class="hljs-number">3</span>],
    channel: SLACK_LOGIN_NOTIFICATION_CHANNEL,
    username: msg[<span class="hljs-number">0</span>],
    icon_emoji: <span class="hljs-string">''</span>
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Handle session events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (msg[<span class="hljs-number">1</span>] == <span class="hljs-string">'Start session'</span>) {
    mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.sessionStartTopic'</span>), msg[<span class="hljs-number">0</span>] + <span class="hljs-string">': '</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'/'</span> + msg[<span class="hljs-number">3</span>]);
  };

  <span class="hljs-keyword">if</span> (msg[<span class="hljs-number">1</span>] == <span class="hljs-string">'Stop session'</span>) {
    mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.sessionStopTopic'</span>), msg[<span class="hljs-number">0</span>] + <span class="hljs-string">': '</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'/'</span> + msg[<span class="hljs-number">3</span>]);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Handle connection events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (msg[<span class="hljs-number">1</span>] == <span class="hljs-string">'Open connection'</span>) {
    mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.connectionOpenTopic'</span>), msg[<span class="hljs-number">0</span>] + <span class="hljs-string">': '</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'/'</span> + msg[<span class="hljs-number">3</span>]);
  };

  <span class="hljs-keyword">if</span> (msg[<span class="hljs-number">1</span>] == <span class="hljs-string">'Close connection'</span>) {
    mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.connectionCloseTopic'</span>), msg[<span class="hljs-number">0</span>] + <span class="hljs-string">': '</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'/'</span> + msg[<span class="hljs-number">3</span>]);
  };

});</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="set-up-udp-server-for-acting-on-sense-failed-task-events">Set up UDP server for acting on Sense failed task events</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Handler for UDP server startup event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerTaskFailure.on(<span class="hljs-string">'listening'</span>, () =&gt; {
  <span class="hljs-keyword">var</span> address = udpServerTaskFailure.address();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'UDP server listening on %s:%s'</span>, address.address, address.port);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Publish MQTT message that UDP server has started</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.taskFailureServerStatusTopic'</span>), <span class="hljs-string">'start'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Handler for UDP error event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerTaskFailure.on(<span class="hljs-string">'error'</span>, () =&gt; {
  <span class="hljs-keyword">var</span> address = udpServerTaskFailure.address();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'UDP server error on %s:%s'</span>, address.address, address.port);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Publish MQTT message that UDP server has reported an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.taskFailureServerStatusTopic'</span>), <span class="hljs-string">'error'</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Main handler for UDP messages relating to failed tasks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerTaskFailure.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message, remote</span>) </span>{
  <span class="hljs-keyword">var</span> msg = message.toString().split(<span class="hljs-string">';'</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'%s: Task "%s" failed, associated with app "%s'</span>, msg[<span class="hljs-number">0</span>], msg[<span class="hljs-number">1</span>], msg[<span class="hljs-number">2</span>], msg[<span class="hljs-number">3</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Post to Slack when a task has failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slack.send({
    text: <span class="hljs-string">'Failed task: "'</span> + msg[<span class="hljs-number">1</span>] + <span class="hljs-string">'", linked to app "'</span> + msg[<span class="hljs-number">2</span>] + <span class="hljs-string">'".'</span>,
    channel: SLACK_TASK_FAILURE_CHANNEL,
    username: msg[<span class="hljs-number">0</span>],
    icon_emoji: <span class="hljs-string">':ghost:'</span>
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Publish MQTT message when a task has failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mqttClient.publish(config.get(<span class="hljs-string">'Butler.mqttConfig.taskFailureTopic'</span>), msg[<span class="hljs-number">1</span>]);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Set up endpoints for REST server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>restServer.get(<span class="hljs-string">'/slackPostMessage'</span>, rest.slackPostMessage.respondSlackPostMessage);
restServer.get(<span class="hljs-string">'/createDir'</span>, rest.createDir.respondCreateDir);
restServer.get(<span class="hljs-string">'/getDiskSpace'</span>, rest.getDiskSpace.respondGetDiskSpace);
restServer.get(<span class="hljs-string">'/mqttPublishMessage'</span>, rest.mqttPublishMessage.respondMQTTPublishMessage);
restServer.get(<span class="hljs-string">'/senseStartTask'</span>, rest.senseStartTask.respondSenseStartTask);
restServer.get(<span class="hljs-string">'/senseQRSPing'</span>, rest.senseQRSPing.respondSenseQRSPing);
restServer.get(<span class="hljs-string">'/butlerPing'</span>, rest.butlerPing.respondButlerPing);</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Start REST server on port 8080</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>restServer.listen(config.get(<span class="hljs-string">'Butler.restServerConfig.serverPort'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>console.log(‘%s REST server listening on %s’, restServer.name, restServer.url);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">'REST server listening on %s'</span>, restServer.url);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Start UDP server for Session and Connection events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerSessionConnection.bind(UDP_PORT_SESSION_CONNECTION, UDP_HOST);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Start UDP server for failed task events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>udpServerTaskFailure.bind(UDP_PORT_TASK_FAILURE, UDP_HOST);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
